#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <pthread.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

/* Enable 1024-bit certificate buffers before including certs_test.h */
#define USE_CERT_BUFFERS_1024

/* WolfSSL must be included after standard headers */
#include <wolfssl/options.h>
#include <wolfssl/ssl.h>
#include <wolfssl/certs_test.h>

/* Data for each relay - list of data items */
const char *RELAY_DATA_LIST_1[] = {
    "330741205700969115713397240479751088242316136206442622210182462263502418603781010948141813045560394925935021380595610580741226447003877094755929931818055830096324533812381604646740490377993981989697174995353307708801039492055683757961224810657696540998540066081903508705158762474181571992093066897193250386868167",
    "291604753206671347285790472081172215338366734953301275958789903767290357133768203099500286372376530997155477691541182773639963750915316126167376849731309924340848089994018276930006572728209518693530541477614201230363851756449857527838400176929797368820881106889680361879854827836500146548943414170443751180857257",
    "460279558368422576107651525116671535108816269250054863953385481424370429103395803185120306001319650022795980896650785561300969989766166511130557434248777315241971734316116402777814186930866052223595347376061819855450543352543033772966020350589590424418478404106153874586528679796634234094998807443150508693133075",
    "Data from Relay 1 [3]: sensor_value=42.9, timestamp=2026-02-04",
    "Data from Relay 1 [4]: sensor_value=43.2, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_1 = sizeof(RELAY_DATA_LIST_1) / sizeof(RELAY_DATA_LIST_1[0]);

const char *RELAY_DATA_LIST_2[] = {
    "28431712284660308480796810849825615486312104939255545317199551099585900688558313420949913660490648717715083665856069968528886396139080518256256459511860682599426713888832506605646606292301268536516271298283287790324650481277466894360269813661356944708953192827879234998217077856944708114642991507845995589965508",
    "243446239934676907756392272957694514271914319056407063164034493747182182781455276186822897279702700219840241305443462641383309414626800978913965179286749877573277734910813151896762174771671235523215927776100014933618317275472382099375438385695320397457038119059201422569587154524289261722681793295788897902377142",
    "286205862183042975143463834432710561110192659019954938605116550219482570014979726537980077130165343948850076522297124892662809151268922946116140270925024496473787581552321245215617403022277820013734253076166384423999685614093532659951326611030657667251104339166230846300824777760707377429224392185085490213953057",
    "Data from Relay 2 [3]: sensor_value=37.6, timestamp=2026-02-04",
    "Data from Relay 2 [4]: sensor_value=37.3, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_2 = sizeof(RELAY_DATA_LIST_2) / sizeof(RELAY_DATA_LIST_2[0]);

const char *RELAY_DATA_LIST_3[] = {
    "147718543213883574979183225699647208974969558609273886537988539453457831210866562634570182533632997143303228687178866355022261880882636502556347008133617018766483147411137474172338792732648528570351372731140304866375512031153347582651024774631188477189132642444887159415240882059391161613442533109469228967076231",
    "203838463861422483128932584197852510082040079729137561423388319054372665634943642426993483918018472785000048138787376297746396050425378352435848130615295236876678216542214478813837540561221329843762443172248703872883044303258669032412275306847669400683757362051848823492631851873304867277634332069512397794303701",
    "407009028645554385090727760941791524542076948688257448242103768711559913815975673668525859377558720653221333941175629767326242163581795349185649123994208603037704665566620425697951689229563630627114578913688916927241243505669472572021728936709610158257934188913238734628086032635409374326764798156892839054069754",
    "Data from Relay 3 [3]: sensor_value=55.2, timestamp=2026-02-04",
    "Data from Relay 3 [4]: sensor_value=55.4, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_3 = sizeof(RELAY_DATA_LIST_3) / sizeof(RELAY_DATA_LIST_3[0]);

const char *RELAY_DATA_LIST_4[] = {
    "32665188724042771104452276431999894028865566063934050080042784561840352234200888205524910088337005503424885197818481666344602516543338521445390732318985541538353216117537119086812045266243823484539229418446830766215556222640054441145284996401866614421118090536031015537020117493897142251003031934189847853541334",
    "156583049666270061423668505558972450279150485177161613468348778730310466311060847859336976353028890040545765915726828654016854992028918436565454478545860727930989083530316705731938340084099522323170982978741849750040894872295426616416397235111044554154609732908439335952459629066240891397566421197675349502238204",
    "106164411696760567540847308124377235503510711627568476455674788889339183267009769562840159175884838954453532634302682487433382023240190113311462313973707507595877168484363594118241882681769487933768918476656421628071626006075582278487415661872561170104653587577452362152176776130625982154737791636204789810006337",
    "Data from Relay 4 [3]: sensor_value=28.8, timestamp=2026-02-04",
    "Data from Relay 4 [4]: sensor_value=29.0, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_4 = sizeof(RELAY_DATA_LIST_4) / sizeof(RELAY_DATA_LIST_4[0]);

const char *RELAY_DATA_LIST_5[] = {
    "399210582304649310278165416944385437325674132471872334094918255413968660229950234672954925472717613779927522833440635909165197363525695767364328738544853826188430282151054173886941607830125251340085496690997326932488579989243590142689246862519517193378879051495341330868879384164619439796834247031278200932611071",
    "349217339588510791632622224975233664368054596130659977775936423697581713575830531743138996009421564687796542142584836999819008809778112592801900628459496795438451396270780199159556319061269735310273507198428528632443645978860805196456575349273128208467276889343125174090703416204693169651604929045085011754432356",
    "428039396535503768466113610123946442183219263308479739621079505866128968788311985795225888374007770340207013018470059577540224340283834096238718798652729809616261220805513930997663623413672207936191860500242870281166758784322856787217790671398419692397473304712683319608726570381328352643070671349869367570950012",
    "Data from Relay 5 [3]: sensor_value=61.6, timestamp=2026-02-04",
    "Data from Relay 5 [4]: sensor_value=61.4, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_5 = sizeof(RELAY_DATA_LIST_5) / sizeof(RELAY_DATA_LIST_5[0]);

const char *RELAY_DATA_LIST_6[] = {
    "238903077611147253577433030096050989895941939649089742702469360798269453881766660923376417111902713577614983278611940129804308432248502003577286329287378909889550308675143252031884004402783798040235774014112276165284375561127515131015632733203193812115848321913225438618204699340006756403988265120074814414202550",
    "288031795436505268681846671029732894057413331035599903554312123831206129979811736219981108966608506153593502755069775904618316783246553949577199995151833898357540933928810641314110431315002837109166467124441924595411245990452362461274666239678004821020125398171427331003775499597197206055440830011541159901745593",
    "381252863395585176362631110143157605288927670078443441559152176963557734961837227663806107560919403579307297477877758906588813084359805163578048168073665386782630386559168434600598008428883450073288402268442123657074368757437639965000250032643602642849706672634496166379174380465277740958584926848465597385359151",
    "Data from Relay 6 [3]: sensor_value=44.7, timestamp=2026-02-04",
    "Data from Relay 6 [4]: sensor_value=44.4, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_6 = sizeof(RELAY_DATA_LIST_6) / sizeof(RELAY_DATA_LIST_6[0]);

const char *RELAY_DATA_LIST_7[] = {
    "293633406747414571270994289343466901337418409395655063959314062186793995687572174450241830855300568061474796655944841205515030691623373721603089105077269805770922072982792191359465310105871376042795303813312902873900236725037418379261218036677695111917254297043124688920762130448054073592430332610750981575426535",
    "40964195179684280222658244549801047234097152139692847288053799651735572409769303953061025217402724245837445185067127766641386164643098490741218647294218363283088275429987848085257363449573212130793679553169815454071616180141494349448606142253600303007306697149074439022253756399618640605743366908024413925759551",
    "393940481424201152056360443466969138026799904068431609280142899012174430916619033405257658296459088132395503566746711322193812295873803147261922505936724682207216788301641333158446718362194327575050440377992707082494573793244996046539088897375857295916920935450672066744544069497593631070110161318713764925083097",
    "Data from Relay 7 [3]: sensor_value=33.0, timestamp=2026-02-04",
    "Data from Relay 7 [4]: sensor_value=33.2, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_7 = sizeof(RELAY_DATA_LIST_7) / sizeof(RELAY_DATA_LIST_7[0]);

const char *RELAY_DATA_LIST_8[] = {
    "313659426614670095573963069497670528604526730124083480659390158101281891887131035393315003064811217758164134318980682420332592007740720105407155063317086609520790237246883288048971505722671854432496823433253879039160602669656457136813535803368095445220272314431136058378289594541967269985046465939127777564852791",
    "443698827339929316946688888281573572539695710575319602170286879823707014097744346015205040466502247059313677450264903980478702515677509655177560028575004446146945366413565842382207999645082646617843435283303150846678384422699834783141074664889513081624497357206648792040135317137037678646040238508830129357771127",
    "307178986531914244888624875826433428800797167285984827891859944949762987116703378301765565260403373783893027144745834566093406125902406535567667849259750967906918968562091001727274622906149651809500109856036182639728669465120283202350400410063635121135050179565496699300251407442192298043318371591006091337517843",
    "Data from Relay 8 [3]: sensor_value=48.7, timestamp=2026-02-04",
    "Data from Relay 8 [4]: sensor_value=48.9, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_8 = sizeof(RELAY_DATA_LIST_8) / sizeof(RELAY_DATA_LIST_8[0]);

const char *RELAY_DATA_LIST_9[] = {
    "107912669579519411612685646468821648143512323682452826806576286502396855817921532309231775055145435905619775256681488560169810617099867652085947794956473320346014408808748680518406063844758318276232706972531660086605448695292934253096616567529556121465601265780721741217224006517291172603293435508991193881615097",
    "236198017949447864786727358185311861357133586178830306714484608217110996526784789883467483226795701384908167954323494386647184496480743303507692745001997734208538242994892832237934120375908273867382698391944271011909539104934796470672130345949866954108498807901472039806451000139813404667679207080737236737927287",
    "131290892745913994816906622709680317739146087732642457631049596681379341754505282099481528119788019531340436381315469708561789747804417588945249908575473059674815252694705801318766616335528944787863437828402552690598763881776762861737677291977438667491845288411350564063945690989325782258527974814990674592605058",
    "Data from Relay 9 [3]: sensor_value=51.5, timestamp=2026-02-04",
    "Data from Relay 9 [4]: sensor_value=51.7, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_9 = sizeof(RELAY_DATA_LIST_9) / sizeof(RELAY_DATA_LIST_9[0]);

const char *RELAY_DATA_LIST_10[] = {
    "8260002786498509487125023185102738832177991027010937703514157113463081030039373752942815757165656772141853353912268304707881531757022909848158912069649648585424612414119564667018982854294710835161811586579947760530372210457865325911897236197848137411179974426108998755187575720939116086134126368811664770005965",
    "209715897383891668844971343408523601170061053961243389715976902399275065189529090058105664387065894773708929217612369250332664447514546682395884217692216835447881503326341655117105434494406045223612346214026159163840972257594350440959717450477690962037994232510592746678891393729002193846748060507858844838345241",
    "66167830282902131576252338827815585788366708150934182381319269568974469851457240637409282626603740284787326687698195514317415479182018221015571297474937315757190087990271604480512112293679876541264589891466197514031022426901753719643095315052630431302797229594931236679628388763662419706614026373437269587634279",
    "Data from Relay 10 [3]: sensor_value=39.9, timestamp=2026-02-04",
    "Data from Relay 10 [4]: sensor_value=40.1, timestamp=2026-02-05",
};
const int RELAY_DATA_COUNT_10 = sizeof(RELAY_DATA_LIST_10) / sizeof(RELAY_DATA_LIST_10[0]);

typedef struct
{
    WOLFSSL *ssl;
    int client_sock;
    int relay_id;
    const char **relay_data_list;
    int data_count;
} client_context_t;

// Global request index per relay (1-10). Persists across connections.
static int g_relay_request_index[11] = {0};

void *handle_client(void *arg)
{
    client_context_t *ctx = (client_context_t *)arg;
    WOLFSSL *ssl = ctx->ssl;
    int relay_id = ctx->relay_id;
    const char **relay_data_list = ctx->relay_data_list;
    int data_count = ctx->data_count;
    int ret;
    unsigned char size_bytes[4];
    uint32_t request_size;
    unsigned char request[2048];
    int *request_index = NULL;

    printf("[RELAY-%d] Client connected\n", relay_id);

    if (relay_id >= 1 && relay_id <= 10)
    {
        request_index = &g_relay_request_index[relay_id];
    }

    /* TLS handshake */
    while ((ret = wolfSSL_accept(ssl)) != WOLFSSL_SUCCESS)
    {
        int err = wolfSSL_get_error(ssl, ret);
        if (err != SSL_ERROR_WANT_READ && err != SSL_ERROR_WANT_WRITE)
        {
            printf("[RELAY-%d] TLS handshake failed: %d\n", relay_id, err);
            goto cleanup;
        }
    }

    printf("[RELAY-%d] TLS handshake OK\n", relay_id);

    /* Main loop - handle multiple requests from client */
    while (1)
    {
        /* Receive request: [size:4][data] */
        ret = wolfSSL_read(ssl, size_bytes, 4);
        if (ret <= 0)
        {
            printf("[RELAY-%d] Client disconnected or read failed\n", relay_id);
            break;
        }

        request_size = *(uint32_t *)size_bytes;
        int current_index = (request_index != NULL) ? *request_index : 0;
        printf("[RELAY-%d] Received request #%d (size=%u)\n", relay_id, current_index + 1, request_size);

        if (request_size > 0 && request_size < 2048)
        {
            ret = wolfSSL_read(ssl, request, request_size);
            if (ret > 0)
            {
                request[ret] = '\0';
                printf("[RELAY-%d] Request data: %s\n", relay_id, (char *)request);
            }
        }

        /* Send response: [size:4][data from list] */
        const char *response_data;
        uint32_t response_len;

        if (current_index < data_count)
        {
            response_data = relay_data_list[current_index];
            response_len = strlen(response_data);
            printf("[RELAY-%d] Sending response #%d (%u bytes)\n", relay_id, current_index + 1, response_len);
        }
        else
        {
            response_data = "No more data available";
            response_len = strlen(response_data);
            printf("[RELAY-%d] All data exhausted, sending end message\n", relay_id);
        }

        ret = wolfSSL_write(ssl, (unsigned char *)&response_len, 4);
        if (ret != 4)
        {
            printf("[RELAY-%d] Failed to send response size\n", relay_id);
            break;
        }

        ret = wolfSSL_write(ssl, (unsigned char *)response_data, response_len);
        if (ret != (int)response_len)
        {
            printf("[RELAY-%d] Failed to send response data\n", relay_id);
            break;
        }

        printf("[RELAY-%d] Response #%d sent\n", relay_id, current_index + 1);
        if (request_index != NULL)
        {
            (*request_index)++;
        }

        /* If all data sent, close connection */
        if (request_index != NULL && *request_index >= data_count)
        {
            printf("[RELAY-%d] All data sent, closing connection\n", relay_id);
            break;
        }
    }

cleanup:
    wolfSSL_shutdown(ssl);
    wolfSSL_free(ssl);
    close(ctx->client_sock);
    free(ctx);
    printf("[RELAY-%d] Client disconnected\n", relay_id);
    return NULL;
}

int start_relay_server(int relay_id, int port, const char **relay_data_list, int data_count)
{
    printf("[RELAY-%d] Starting on port %d\n", relay_id, port);

    wolfSSL_library_init();

    /* Create WolfTLS context */
    WOLFSSL_CTX *ssl_ctx = wolfSSL_CTX_new(wolfTLSv1_2_server_method());
    if (!ssl_ctx)
    {
        printf("[RELAY-%d] Failed to create WolfSSL context\n", relay_id);
        return 1;
    }

    /* Load test certificates */
    int ret = wolfSSL_CTX_use_certificate_buffer(ssl_ctx, server_cert_der_1024, sizeof(server_cert_der_1024), SSL_FILETYPE_ASN1);
    if (ret != WOLFSSL_SUCCESS)
    {
        printf("[RELAY-%d] Failed to load certificate\n", relay_id);
        return 1;
    }

    ret = wolfSSL_CTX_use_PrivateKey_buffer(ssl_ctx, server_key_der_1024, sizeof(server_key_der_1024), SSL_FILETYPE_ASN1);
    if (ret != WOLFSSL_SUCCESS)
    {
        printf("[RELAY-%d] Failed to load private key\n", relay_id);
        return 1;
    }

    printf("[RELAY-%d] WolfSSL context initialized\n", relay_id);

    /* Create listening socket */
    int listen_fd = socket(AF_INET, SOCK_STREAM, 0);
    if (listen_fd < 0)
    {
        printf("[RELAY-%d] Failed to create socket\n", relay_id);
        return 1;
    }

    int opt = 1;
    setsockopt(listen_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));

    struct sockaddr_in addr;
    memset(&addr, 0, sizeof(addr));
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = htonl(INADDR_ANY);
    addr.sin_port = htons(port);

    if (bind(listen_fd, (struct sockaddr *)&addr, sizeof(addr)) < 0)
    {
        printf("[RELAY-%d] Failed to bind to port %d\n", relay_id, port);
        return 1;
    }

    if (listen(listen_fd, 5) < 0)
    {
        printf("[RELAY-%d] Failed to listen\n", relay_id);
        return 1;
    }

    printf("[RELAY-%d] Listening on port %d\n", relay_id, port);

    while (1)
    {
        struct sockaddr_in client_addr;
        socklen_t client_addr_len = sizeof(client_addr);

        int client_sock = accept(listen_fd, (struct sockaddr *)&client_addr, &client_addr_len);
        if (client_sock < 0)
        {
            printf("[RELAY-%d] Accept failed\n", relay_id);
            continue;
        }

        WOLFSSL *ssl = wolfSSL_new(ssl_ctx);
        if (!ssl)
        {
            printf("[RELAY-%d] Failed to create SSL object\n", relay_id);
            close(client_sock);
            continue;
        }

        wolfSSL_set_fd(ssl, client_sock);

        client_context_t *ctx = (client_context_t *)malloc(sizeof(client_context_t));
        if (!ctx)
        {
            wolfSSL_free(ssl);
            close(client_sock);
            continue;
        }

        ctx->ssl = ssl;
        ctx->client_sock = client_sock;
        ctx->relay_id = relay_id;
        ctx->relay_data_list = relay_data_list;
        ctx->data_count = data_count;

        pthread_t thread;
        pthread_create(&thread, NULL, handle_client, ctx);
        pthread_detach(thread);
    }

    wolfSSL_CTX_free(ssl_ctx);
    close(listen_fd);
    return 0;
}

int main(int argc, char *argv[])
{
    int relay_id = 1;
    int port = 13001;
    const char **relay_data_list = RELAY_DATA_LIST_1;
    int data_count = RELAY_DATA_COUNT_1;

    if (argc > 1)
    {
        relay_id = atoi(argv[1]);
        port = 13000 + relay_id;

        switch (relay_id)
        {
        case 1:
            relay_data_list = RELAY_DATA_LIST_1;
            data_count = RELAY_DATA_COUNT_1;
            break;
        case 2:
            relay_data_list = RELAY_DATA_LIST_2;
            data_count = RELAY_DATA_COUNT_2;
            break;
        case 3:
            relay_data_list = RELAY_DATA_LIST_3;
            data_count = RELAY_DATA_COUNT_3;
            break;
        case 4:
            relay_data_list = RELAY_DATA_LIST_4;
            data_count = RELAY_DATA_COUNT_4;
            break;
        case 5:
            relay_data_list = RELAY_DATA_LIST_5;
            data_count = RELAY_DATA_COUNT_5;
            break;
        case 6:
            relay_data_list = RELAY_DATA_LIST_6;
            data_count = RELAY_DATA_COUNT_6;
            break;
        case 7:
            relay_data_list = RELAY_DATA_LIST_7;
            data_count = RELAY_DATA_COUNT_7;
            break;
        case 8:
            relay_data_list = RELAY_DATA_LIST_8;
            data_count = RELAY_DATA_COUNT_8;
            break;
        case 9:
            relay_data_list = RELAY_DATA_LIST_9;
            data_count = RELAY_DATA_COUNT_9;
            break;
        case 10:
            relay_data_list = RELAY_DATA_LIST_10;
            data_count = RELAY_DATA_COUNT_10;
            break;
        default:
            printf("Invalid relay_id %d (expected 1-10)\n", relay_id);
            return 1;
        }
    }

    printf("=== DistributionVC Data Relay Server (WolfTLS) ===\n");
    return start_relay_server(relay_id, port, relay_data_list, data_count);
}
